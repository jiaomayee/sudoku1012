# 技巧模块开发文档

## 功能概述
我们将为所有的技巧开发技巧指示功能，技巧指示功能是当用户选择技巧机会时，在棋盘上为用户提供该技巧的用法教学，包括高亮特定单元格，高亮特定候选数，并且需要使用不同的高亮底色。部分技巧还需要在棋盘上方通过DOM生成图层，标注方框，划线等功能。

## 技巧分类
### 基础技巧（第一优先级）
- **唯一数法** (Naked Single)：单元格中只剩下一个可能的数字
- **隐性唯一数法** (Hidden Single)：某一行、列或宫中，某个数字只能出现在特定的单元格中

### 候选数基础技巧（第二优先级）
- **候选数唯一法** (Notes Single)：单元格的候选数中只有一个数字

### 中级技巧（第三优先级）
- **显性数对法** (Naked Pair)：某一行、列或宫中，两个单元格的候选数恰好是两个相同的数字
- **隐性数对法** (Hidden Pair)：某一行、列或宫中，两个数字只能出现在两个特定的单元格中
- **指向对法** (Pointing Pairs)：当一个数字在某个3x3宫格中只能出现在同一行或同一列时
- **宫行列排除法** (Box-Line Reduction)：当一个数字在某一行或列中只能出现在同一个3x3宫格内时

### 高级技巧（第四优先级）
- **显性三链数法** (Naked Triple)：某一行、列或宫中，三个单元格的候选数恰好是三个相同的数字（可能有子集）
- **隐性三链数法** (Hidden Triple)：某一行、列或宫中，三个数字只能出现在三个特定的单元格中
- **X-Wing**：当两行或两列中的某一数字仅出现在四个单元格中，且形成矩形结构时
- **Y-Wing/XZ-Wing**：由三个双值单元格组成的结构，其中两个单元格与第三个单元格共享一个候选数
- **XY-Wing**：由三个双值单元格组成的结构，中间单元格与另外两个单元格分别共享一个候选数
- **XYZ-Wing**：由一个三值单元格和两个双值单元格组成的结构

## 基础技巧指示功能要求
1. **高亮目标单元格**
   - 使用不太明亮的黄色底色（#f9e79f）
   - 四周显示白色选中框，线条较粗（3px）
2. **显示预填入数字**
   - 在目标单元格中央显示绿色的预填入数字（#2ecc71）
   - 字体大小与用户填入数字大小相同

## 示例
技巧机会计划在（1，5）单元格填入数字9，技巧指示功能：
- 以不太明亮的黄色底色高亮（1，5）单元格
- 该单元格四周显示粗白色边框
- 在单元格中央显示绿色的数字9，字体大小与用户填入数字相同

## 交互要求
1. **技巧模式定义**
   - 打开"技巧"或"解题"标签页时，自动进入技巧模式
   - 技巧模式下可以查看和选择技巧机会

2. **技巧模式退出机制**
   - 用户点击棋盘中的任意单元格时，自动退出技巧模式
   - 用户点击"键盘"标签页按钮时，自动退出技巧模式

3. **退出技巧模式行为**
   - 自动切换到"键盘"标签页
   - 清除所有技巧指示高亮
   - 重置当前选中的技巧和步骤状态
   - 恢复正常编辑状态，允许用户输入数字

## 候选数删除无效检查机制
为了确保技巧提示的有效性，我们实现了候选数删除无效检查机制，对于所有涉及候选数删除的技巧（数对、三链数、指向对、宫行列排除等），只有当存在实际可删除的候选数时，才将该技巧机会视为有效并提供给用户。

### 检查逻辑实现
1. 对于每个识别到的技巧机会，检查是否有可以实际删除的候选数
2. 收集需要删除候选数的目标单元格（targetCells）
3. 收集可以删除的具体候选数（removableCandidates）
4. 只有当targetCells长度大于0时，才将该技巧机会添加到结果中

## 刷新候选数按钮工作逻辑
"刷新候选数"按钮是数独解题过程中的重要工具，用于确保候选数的准确性和完整性。以下是该按钮的完整工作逻辑：

### 核心流程
1. **空白单元格候选数状态检查**
   - 检查棋盘中是否存在任何**无候选数的空白单元格**（即未预填入数字且未被用户填入正确数字的单元格）
   - 空白单元格定义：既不是预填数字，也不是用户已填入正确数字的单元格

2. **存在无候选数的空白单元格时**
   - 启动候选数算法，为**所有空白单元格**（非预填入数字或用户填入正确数后的单元格）填充候选数
   - 覆盖用户之前可能手动填入的候选数
   - 填充完成后，基于当前棋盘数据求解技巧机会

3. **所有空白单元格都有候选数时**
   - 利用数独题目的正确答案，检查每个空白单元格中是否缺少正确答案对应的候选数
   - 检查逻辑：对于每个空白单元格，其候选数集合是否包含该单元格的正确答案

4. **发现候选数错误时**
   - 弹出提示框，显示信息："存在候选数删减错误，数据刷新"
   - 启动候选数算法，为**所有空白单元格**（非预填入数字或用户填入正确数后的单元格）重新填充候选数
   - 覆盖所有现有的候选数
   - 填充完成后，基于当前棋盘数据求解技巧机会

5. **候选数正确完整时**
   - 无需重新生成候选数，直接基于当前棋盘数据求解技巧机会

### 候选数算法实现细节
- **calculateCellCandidates函数**：通过isValidMove验证1-9数字的有效性，生成特定单元格的候选数
- **fillAllCandidates函数**：遍历所有空白单元格，调用calculateCellCandidates生成候选数并更新状态
- **候选数覆盖机制**：刷新过程会完全覆盖用户手动输入的候选数，确保候选数的一致性和准确性

### 用户体验设计
- 刷新操作完成后，自动切换到技巧标签页，方便用户查看求解机会
- 候选数错误提示明确告知用户问题所在，使用户了解刷新的原因
- 操作流畅且自动化，减少用户手动管理候选数的负担

## 算法详细逻辑

### 1. 唯一数法 (findNakedSingles)
- **逻辑**：遍历每个单元格，如果单元格为空且其所在行、列、宫中已经包含8个不同的数字，则该单元格只能填入剩下的那个数字
- **返回结构**：包含type、row、col、value和message字段的对象数组

### 2. 隐性唯一数法 (findHiddenSingles)
- **逻辑**：
  - 分别检查每一行、每一列和每一宫
  - 对于每个数字，检查它在该行/列/宫中可能出现的位置
  - 如果一个数字在某行/列/宫中只能出现在一个单元格，则该单元格必须填入这个数字
- **返回结构**：包含type、description、row、col、value和message字段的对象数组

### 3. 候选数唯一法 (findNotesSingles)
- **逻辑**：遍历每个单元格，如果单元格为空且其候选数数组只有一个数字，则该单元格必须填入这个数字
- **返回结构**：包含type、description、row、col、value和message字段的对象数组

### 4. 显性数对法 (findNakedPairs)
- **逻辑**：
  - 分别检查每一行、每一列和每一宫
  - 对于每两个单元格，检查它们的候选数是否完全相同且恰好包含两个数字
  - 如果找到这样的两个单元格，则这两个数字只能出现在这两个单元格中
  - 检查该行/列/宫中其他单元格是否包含这两个候选数，如果有则可以删除
- **返回结构**：包含type、description、cells、values、targetCells、removableCandidates和message字段的对象数组

### 5. 隐性数对法 (findHiddenPairs)
- **逻辑**：
  - 分别检查每一行、每一列和每一宫
  - 对于每两个数字，检查它们在该行/列/宫中可能出现的位置是否完全相同且恰好出现在两个单元格中
  - 如果找到这样的两个数字，则这两个单元格中只能包含这两个数字
  - 检查这两个单元格中是否包含其他候选数，如果有则可以删除
- **返回结构**：包含type、description、cells、values、targetCells、removableCandidates和message字段的对象数组

### 6. 指向对法 (findPointingPairs)
- **逻辑**：
  - 检查每个宫格中的每个数字
  - 如果一个数字在某宫中只能出现在同一行或同一列
  - 则该行或该列中其他宫格内的该数字候选数可以被删除
- **返回结构**：包含type、description、boxRow、boxCol、row/col、number、sourceCells、targetCells、removableCandidates和message字段的对象数组

### 7. 宫行列排除法 (findBoxLineReduction)
- **逻辑**：
  - 检查每一行和每一列中的每个数字
  - 如果一个数字在某行/列中只能出现在同一个宫格内
  - 则该宫中其他行/列内的该数字候选数可以被删除
- **返回结构**：包含type、description、row/col、boxRow、boxCol、number、sourceCells、targetCells、removableCandidates和message字段的对象数组

### 8. 显性三链数法 (findNakedTriples)
- **逻辑**：
  - 分别检查每一行、每一列和每一宫
  - 对于每三个单元格，检查它们的候选数的并集是否恰好包含三个数字，且每个单元格的候选数都是这个集合的子集
  - 如果找到这样的三个单元格，则这三个数字只能出现在这三个单元格中
  - 检查该行/列/宫中其他单元格是否包含这三个候选数，如果有则可以删除
- **返回结构**：包含type、description、cells、values、targetCells、removableCandidates和message字段的对象数组

### 9. 隐性三链数法 (findHiddenTriples)
- **逻辑**：
  - 分别检查每一行、每一列和每一宫
  - 对于每三个数字，检查它们在该行/列/宫中可能出现的位置是否完全相同且恰好出现在三个单元格中
  - 如果找到这样的三个数字，则这三个单元格中只能包含这三个数字
  - 检查这三个单元格中是否包含其他候选数，如果有则可以删除
- **返回结构**：包含type、description、cells、values、targetCells、removableCandidates和message字段的对象数组

### 10. X-Wing技巧 (findXWing)
- **逻辑**：
  - 检查每一行对中的每个数字
  - 如果一个数字在两行中仅出现在相同的两列中
  - 则这两列中其他行的该数字候选数可以被删除
  - 同样检查列对中的情况
- **返回结构**：包含type、description、rows/cols、columns/rows、number、sourceCells、targetCells、removableCandidates和message字段的对象数组

### 11. Y-Wing/XZ-Wing技巧 (findYWing)
- **逻辑**：
  - 寻找满足条件的三个双值单元格：
    1. 一个中心单元格（称为"枢纽"）包含候选数{X,Y}
    2. 两个翼单元格，一个包含{X,Z}，另一个包含{Y,Z}
    3. 翼单元格不能在同一行、列或宫中
  - 这三个单元格形成Y-Wing结构后，可以删除与两个翼单元格共同影响区域的候选数Z
- **返回结构**：包含type、description、pivotCell、wingCells、values、targetCells、removableCandidates和message字段的对象数组

### 12. XY-Wing技巧 (findXYWing)
- **逻辑**：
  - 寻找满足条件的三个双值单元格：
    1. 一个中心单元格（称为"枢纽"）包含候选数{X,Y}
    2. 两个翼单元格，一个包含{X,Z}，另一个包含{Y,Z}
    3. 翼单元格与枢纽在同一行/列/宫中
  - 这三个单元格形成XY-Wing结构后，可以删除与两个翼单元格共同影响区域的候选数Z
- **返回结构**：包含type、description、pivotCell、wingCells、values、targetCells、removableCandidates和message字段的对象数组

### 13. XYZ-Wing技巧 (findXYZWing)
- **逻辑**：
  - 寻找满足条件的三个单元格：
    1. 一个中心单元格（称为"枢纽"）包含候选数{X,Y,Z}
    2. 两个翼单元格，一个包含{X,Z}，另一个包含{Y,Z}
    3. 所有三个单元格在同一个宫中
  - 这三个单元格形成XYZ-Wing结构后，可以删除与枢纽和两个翼单元格共同影响区域的候选数Z
- **返回结构**：包含type、description、pivotCell、wingCells、values、targetCells、removableCandidates和message字段的对象数组

### 14. 技巧识别与应用 (identifyAllTechniques & applyTechnique)
- **识别逻辑**：按优先级顺序调用所有技巧函数，避免重复识别
- **应用逻辑**：根据技巧类型执行不同操作（数字填入或视觉提示）

## 实现原则
1. 使用DOM叠加方式实现高亮，完全隔离新功能与原有棋盘和核心逻辑
2. 后续如果有新的技巧指示功能，也可以用DOM叠加方式实现
3. 所有技巧机会对象保持统一的输出格式，包含必要的字段
4. 只有当存在实际可删除的候选数时，才将候选数删除类技巧机会视为有效
5. 候选数刷新机制确保候选数的准确性和完整性，提供良好的用户体验
6. 候选数错误检测能够及时发现并纠正用户可能的候选数输入错误
7. 高级技巧的视觉指示应清晰展示技巧的结构和作用，使用不同颜色区分枢纽、翼单元格等不同角色
8. 对于需要连线指示的技巧（如X-Wing），使用DOM在棋盘上方绘制连接线，展示技巧的几何关系

## DOM图层实现方案

### 1. 图层架构
为了支持复杂的数独技巧视觉指示，我们采用多层DOM叠加的方式实现：

- **基础层**：原始数独棋盘
- **候选数层**：显示单元格的候选数
- **高亮层**：用于基础的单元格高亮
- **连线层**：用于绘制技巧所需的连接线（如X-Wing的矩形框）
- **标注层**：用于显示额外的标注信息

### 2. 高级技巧视觉指示实现

#### X-Wing视觉指示
- **单元格高亮**：
  - 使用蓝色高亮四个形成矩形的源单元格
  - 使用红色高亮需要删除候选数的目标单元格
- **连接线**：
  - 在四个源单元格之间绘制蓝色虚线，形成矩形
  - 线宽为2px，透明度为0.7
- **候选数高亮**：
  - 高亮显示相关的候选数

#### Y-Wing/XY-Wing视觉指示
- **单元格高亮**：
  - 使用绿色高亮枢纽单元格
  - 使用蓝色高亮两个翼单元格
  - 使用红色高亮需要删除候选数的目标单元格
- **连接线**：
  - 从枢纽单元格到每个翼单元格绘制绿色连接线
  - 线宽为2px，透明度为0.7
- **候选数高亮**：
  - 高亮显示枢纽中的两个候选数，翼中的共享候选数，以及目标单元格中要删除的候选数

#### 图层管理
```javascript
// TechniqueLines.jsx - 用于绘制连接线的组件
const TechniqueLines = ({ lines, boardWidth }) => {
  const cellWidth = boardWidth / 9;
  
  return (
    <svg 
      className="technique-lines"
      style={{
        position: 'absolute',
        top: 0,
        left: 0,
        width: `${boardWidth}px`,
        height: `${boardWidth}px`,
        pointerEvents: 'none',
        zIndex: 25, // 位于高亮层之上
      }}
    >
      {lines.map((line, index) => (
        <line
          key={index}
          x1={(line.x1 + 0.5) * cellWidth}
          y1={(line.y1 + 0.5) * cellWidth}
          x2={(line.x2 + 0.5) * cellWidth}
          y2={(line.y2 + 0.5) * cellWidth}
          stroke={line.color || '#0000ff'}
          strokeWidth={line.width || 2}
          strokeDasharray={line.dashed ? '5,5' : 'none'}
          opacity={line.opacity || 0.7}
        />
      ))}
    </svg>
  );
};
```

### 3. 候选数高亮实现
```javascript
// TechniquePencilNotes.jsx - 用于高亮候选数的组件
const TechniquePencilNotes = ({ highlightedNotes, boardWidth }) => {
  const cellWidth = boardWidth / 9;
  const noteSize = cellWidth / 3; // 每个候选数的大小
  
  return (
    <div 
      className="technique-pencil-notes"
      style={{
        position: 'absolute',
        top: 0,
        left: 0,
        width: `${boardWidth}px`,
        height: `${boardWidth}px`,
        pointerEvents: 'none',
        zIndex: 22,
      }}
    >
      {highlightedNotes.map((note, index) => {
        // 计算候选数在单元格中的位置
        const noteRow = Math.floor((note.number - 1) / 3);
        const noteCol = (note.number - 1) % 3;
        
        return (
          <div
            key={index}
            style={{
              position: 'absolute',
              left: `${note.col * cellWidth + noteCol * noteSize}px`,
              top: `${note.row * cellWidth + noteRow * noteSize}px`,
              width: `${noteSize}px`,
              height: `${noteSize}px`,
              backgroundColor: note.color || '#ff0000',
              opacity: note.opacity || 0.7,
              borderRadius: '3px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              color: '#ffffff',
              fontWeight: 'bold',
              fontSize: `${noteSize * 0.6}px`,
            }}
          >
            {note.number}
          </div>
        );
      })}
    </div>
  );
};
```

## 实现细节

### 核心组件修改

#### 1. ControlPanel.jsx
- **添加退出技巧模式函数**：实现 `exitTechniqueMode()` 函数，统一处理退出逻辑
- **监听选中单元格**：使用 useEffect 监听 selectedCell 变化，当用户点击单元格时自动退出技巧模式
- **标签页切换逻辑**：修改标签页按钮点击事件，在切换到键盘标签页时调用退出函数
- **刷新候选数按钮实现**：添加按钮组件和对应的onClick事件处理函数

```javascript
// 退出技巧模式的函数
const exitTechniqueMode = useCallback(() => {
  // 切换到键盘标签页
  setActiveTab('keyboard');
  // 清除高亮
  if (setHighlightedCells) {
    setHighlightedCells([]);
  }
  // 清除选中的技巧和步骤
  setSelectedTechnique(null);
  setTechniqueSteps([]);
}, [setHighlightedCells]);

// 监听选中单元格的变化，当用户点击单元格时退出技巧模式
useEffect(() => {
  if (selectedCell && activeTab !== 'keyboard') {
    exitTechniqueMode();
  }
}, [selectedCell, activeTab, exitTechniqueMode]);
```

#### 2. SudokuGamePage.jsx
- **增强单元格点击处理**：在 `handleCellClick` 函数中添加清除高亮的逻辑
- **与技巧模式交互**：确保点击单元格时能正确触发技巧模式的退出流程
- **集成高级技巧视觉组件**：添加TechniqueLines和TechniquePencilNotes组件的渲染

```javascript
// 处理单元格选择
const handleCellClick = (row, col) => {
  // 设置选中的单元格
  setSelectedCell({ row, col });
  
  // 退出技巧模式：清除高亮单元格
  if (sudokuContext?.setHighlightedCells) {
    sudokuContext.setHighlightedCells([]);
  }
  
  // 清除技巧线条和候选数高亮
  if (sudokuContext?.setTechniqueLines) {
    sudokuContext.setTechniqueLines([]);
  }
  if (sudokuContext?.setHighlightedNotes) {
    sudokuContext.setHighlightedNotes([]);
  }
};
```

#### 3. TechniqueOverlay.jsx
- **移除候选数高亮**：删除TechniquePencilNotes组件，不再高亮候选数
- **添加预填入数字显示**：在目标单元格中央显示绿色的预填入数字
- **调整高亮样式**：使用不太明亮的黄色背景和粗白色边框

```javascript
// 完全隔离的技巧高亮覆盖层组件 - 实现基础技巧指示功能
const TechniqueOverlay = ({ highlightedCells, boardWidth }) => {
  // 严格检查highlightedCells，确保它是有效的数组
  if (!highlightedCells || !Array.isArray(highlightedCells)) {
    return null;
  }

  // 极其严格的过滤逻辑，只处理明确的技巧高亮单元格
  const techniqueCells = highlightedCells.filter(cell => 
    cell && 
    cell.techniqueIndicator === true && // 必须显式标记为技巧单元格
    typeof cell.row === 'number' && 
    typeof cell.col === 'number' &&
    cell.row >= 0 && cell.row < 9 && // 确保行列值有效
    cell.col >= 0 && cell.col < 9
  );

  // 如果没有明确的技巧高亮单元格，返回null
  if (techniqueCells.length === 0) {
    return null;
  }

  // 计算单元格宽度
  const cellWidth = boardWidth / 9;
  
  // 计算适合的字体大小，与用户填入数字大小相同
  const fontSize = `${Math.max(16, cellWidth * 0.4)}px`;

  return (
    <div 
      className="technique-overlay"
      style={{
        position: 'absolute',
        top: 0,
        left: 0,
        width: `${boardWidth}px`,
        height: `${boardWidth}px`,
        pointerEvents: 'none', // 完全禁用所有事件，不干扰原系统
        zIndex: 15, // 适当的z-index确保可见但不影响原系统
        boxSizing: 'border-box',
        background: 'transparent' // 确保背景完全透明
      }}
    >
      {/* 渲染技巧高亮单元格 - 为每个技巧单元格添加不太明亮的黄色背景和白色粗边框 */}
      {techniqueCells.map((cell) => {
        return (
          <div
            key={`tech-${cell.row}-${cell.col}`}
            style={{
              position: 'absolute',
              left: `${cell.col * cellWidth}px`,
              top: `${cell.row * cellWidth}px`,
              width: `${cellWidth}px`,
              height: `${cellWidth}px`,
              pointerEvents: 'none',
              zIndex: 20,
              // 为技巧指示单元格添加不太明亮的黄色背景
              backgroundColor: cell.highlightColor || '#f9e79f', // 不太明亮的黄色背景，支持自定义颜色
              border: '3px solid #ffffff', // 粗白色边框
              boxSizing: 'border-box',
              borderRadius: '4px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            {/* 显示绿色的预填入数字，字体大小与用户填入数字大小相同 */}
            {cell.number && (
              <span
                style={{
                  fontSize: fontSize,
                  fontWeight: 'bold',
                  color: '#2ecc71', // 绿色
                  zIndex: 30
                }}
              >
                {cell.number}
              </span>
            )}
          </div>
        );
      })}
    </div>
  );
};

### 交互流程

1. **进入技巧模式**：
   - 用户点击"技巧"或"解题"标签页
   - 取消选中任何单元格
   - 准备显示技巧机会列表

2. **退出技巧模式**：
   - 用户点击棋盘单元格 → 触发 handleCellClick → ControlPanel 中的 useEffect 检测到 selectedCell 变化 → 调用 exitTechniqueMode
   - 或用户点击"键盘"标签页 → 直接调用 exitTechniqueMode
   - 执行退出操作：切换标签页、清除高亮、重置状态

3. **刷新候选数流程**：
   - 用户点击"刷新候选数"按钮
   - 检查空白单元格候选数状态
   - 根据检查结果执行候选数生成或错误提示
   - 完成后求解并显示技巧机会

4. **高级技巧指示流程**：
   - 用户选择高级技巧机会
   - 根据技巧类型生成对应的视觉指示：
     - 高亮相关单元格（使用不同颜色区分角色）
     - 绘制连接线显示几何关系
     - 高亮相关候选数
   - 显示预删除的候选数位置

## 涉及文件
- `src/components/ControlPanel.jsx`
- `src/pages/SudokuGamePage.jsx`
- `src/utils/sudokuTechniques.js` - 核心技巧算法实现文件
- `src/utils/sudokuUtils.js` - 候选数生成和工具函数
- `src/components/TechniqueOverlay.jsx` - 技巧指示UI实现
- `src/components/TechniqueLines.jsx` - 技巧连接线实现
- `src/components/TechniquePencilNotes.jsx` - 技巧候选数高亮实现
- `src/context/SudokuContext.jsx` - 候选数管理和状态更新

## 技巧算法实现细节
所有数独技巧算法都在 `sudokuTechniques.js` 文件中实现，按照难度和优先级排序。每个技巧函数都返回统一格式的机会对象，包含足够的信息用于UI展示和技巧应用。候选数删除类技巧都包含了无效检查逻辑，确保只有存在实际可删除的候选数时才将技巧机会视为有效。

候选数生成和管理逻辑主要在 `sudokuUtils.js` 和 `SudokuContext.jsx` 中实现，提供了完整的候选数计算、刷新和错误检测功能。

高级技巧的视觉指示通过多层DOM叠加实现，包括单元格高亮、连接线绘制和候选数高亮，使用不同颜色和样式区分技巧的不同部分，帮助用户理解技巧的工作原理。

## 后续扩展
1. 可以根据需要添加更多高级技巧，如Swordfish、Snyder Notation、WXYZ-Wing等
2. 为每种技巧开发专门的可视化指示方法
3. 实现技巧难度分级和推荐系统
4. 优化候选数算法性能，支持更大规模的数独题目
5. 添加候选数自动刷新机制，在特定操作后自动触发候选数验证
6. 增加技巧教学模式，详细解释每种技巧的原理和应用方法
7. 实现自定义技巧组合，允许用户选择需要使用的技巧类型
8. 添加技巧使用统计和分析功能，帮助用户了解自己在哪些技巧方面需要加强