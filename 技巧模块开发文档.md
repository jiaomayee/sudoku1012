# 技巧模块开发文档

## 功能概述
我们将为所有的技巧开发技巧指示功能，技巧指示功能是当用户选择技巧机会时，在棋盘上为用户提供该技巧的用法教学，包括高亮特定单元格，高亮特定候选数，并且需要使用不同的高亮底色。部分技巧还需要在棋盘上方通过DOM生成图层，标注方框，划线等功能。

## 技巧分类
### 基础技巧
- 唯一数法
- 隐性唯一数法

### 其他技巧
后续定义

## 基础技巧指示功能要求
1. **高亮目标单元格**
   - 使用不太明亮的黄色底色（#f9e79f）
   - 四周显示白色选中框，线条较粗（3px）
2. **显示预填入数字**
   - 在目标单元格中央显示绿色的预填入数字（#2ecc71）
   - 字体大小与用户填入数字大小相同

## 示例
技巧机会计划在（1，5）单元格填入数字9，技巧指示功能：
- 以不太明亮的黄色底色高亮（1，5）单元格
- 该单元格四周显示粗白色边框
- 在单元格中央显示绿色的数字9，字体大小与用户填入数字相同

## 交互要求
1. **技巧模式定义**
   - 打开"技巧"或"解题"标签页时，自动进入技巧模式
   - 技巧模式下可以查看和选择技巧机会

2. **技巧模式退出机制**
   - 用户点击棋盘中的任意单元格时，自动退出技巧模式
   - 用户点击"键盘"标签页按钮时，自动退出技巧模式

3. **退出技巧模式行为**
   - 自动切换到"键盘"标签页
   - 清除所有技巧指示高亮
   - 重置当前选中的技巧和步骤状态
   - 恢复正常编辑状态，允许用户输入数字

## 实现原则
1. 使用DOM叠加方式实现高亮，完全隔离新功能与原有棋盘和核心逻辑
2. 后续如果有新的技巧指示功能，也可以用DOM叠加方式实现

## 实现细节

### 核心组件修改

#### 1. ControlPanel.jsx
- **添加退出技巧模式函数**：实现 `exitTechniqueMode()` 函数，统一处理退出逻辑
- **监听选中单元格**：使用 useEffect 监听 selectedCell 变化，当用户点击单元格时自动退出技巧模式
- **标签页切换逻辑**：修改标签页按钮点击事件，在切换到键盘标签页时调用退出函数

```javascript
// 退出技巧模式的函数
const exitTechniqueMode = useCallback(() => {
  // 切换到键盘标签页
  setActiveTab('keyboard');
  // 清除高亮
  if (setHighlightedCells) {
    setHighlightedCells([]);
  }
  // 清除选中的技巧和步骤
  setSelectedTechnique(null);
  setTechniqueSteps([]);
}, [setHighlightedCells]);

// 监听选中单元格的变化，当用户点击单元格时退出技巧模式
useEffect(() => {
  if (selectedCell && activeTab !== 'keyboard') {
    exitTechniqueMode();
  }
}, [selectedCell, activeTab, exitTechniqueMode]);
```

#### 2. SudokuGamePage.jsx
- **增强单元格点击处理**：在 `handleCellClick` 函数中添加清除高亮的逻辑
- **与技巧模式交互**：确保点击单元格时能正确触发技巧模式的退出流程

```javascript
// 处理单元格选择
const handleCellClick = (row, col) => {
  // 设置选中的单元格
  setSelectedCell({ row, col });
  
  // 退出技巧模式：清除高亮单元格
  if (sudokuContext?.setHighlightedCells) {
    sudokuContext.setHighlightedCells([]);
  }
};
```

#### 3. TechniqueOverlay.jsx
- **移除候选数高亮**：删除TechniquePencilNotes组件，不再高亮候选数
- **添加预填入数字显示**：在目标单元格中央显示绿色的预填入数字
- **调整高亮样式**：使用不太明亮的黄色背景和粗白色边框

```javascript
// 完全隔离的技巧高亮覆盖层组件 - 实现基础技巧指示功能
const TechniqueOverlay = ({ highlightedCells, boardWidth }) => {
  // 严格检查highlightedCells，确保它是有效的数组
  if (!highlightedCells || !Array.isArray(highlightedCells)) {
    return null;
  }

  // 极其严格的过滤逻辑，只处理明确的技巧高亮单元格
  const techniqueCells = highlightedCells.filter(cell => 
    cell && 
    cell.techniqueIndicator === true && // 必须显式标记为技巧单元格
    typeof cell.row === 'number' && 
    typeof cell.col === 'number' &&
    cell.row >= 0 && cell.row < 9 && // 确保行列值有效
    cell.col >= 0 && cell.col < 9
  );

  // 如果没有明确的技巧高亮单元格，返回null
  if (techniqueCells.length === 0) {
    return null;
  }

  // 计算单元格宽度
  const cellWidth = boardWidth / 9;
  
  // 计算适合的字体大小，与用户填入数字大小相同
  const fontSize = `${Math.max(16, cellWidth * 0.4)}px`;

  return (
    <div 
      className="technique-overlay"
      style={{
        position: 'absolute',
        top: 0,
        left: 0,
        width: `${boardWidth}px`,
        height: `${boardWidth}px`,
        pointerEvents: 'none', // 完全禁用所有事件，不干扰原系统
        zIndex: 15, // 适当的z-index确保可见但不影响原系统
        boxSizing: 'border-box',
        background: 'transparent' // 确保背景完全透明
      }}
    >
      {/* 渲染技巧高亮单元格 - 为每个技巧单元格添加不太明亮的黄色背景和白色粗边框 */}
      {techniqueCells.map((cell) => {
        return (
          <div
            key={`tech-${cell.row}-${cell.col}`}
            style={{
              position: 'absolute',
              left: `${cell.col * cellWidth}px`,
              top: `${cell.row * cellWidth}px`,
              width: `${cellWidth}px`,
              height: `${cellWidth}px`,
              pointerEvents: 'none',
              zIndex: 20,
              // 为技巧指示单元格添加不太明亮的黄色背景
              backgroundColor: '#f9e79f', // 不太明亮的黄色背景
              border: '3px solid #ffffff', // 粗白色边框
              boxSizing: 'border-box',
              borderRadius: '4px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            {/* 显示绿色的预填入数字，字体大小与用户填入数字大小相同 */}
            {cell.number && (
              <span
                style={{
                  fontSize: fontSize,
                  fontWeight: 'bold',
                  color: '#2ecc71', // 绿色
                  zIndex: 30
                }}
              >
                {cell.number}
              </span>
            )}
          </div>
        );
      })}
    </div>
  );
};

### 交互流程

1. **进入技巧模式**：
   - 用户点击"技巧"或"解题"标签页
   - 取消选中任何单元格
   - 准备显示技巧机会列表

2. **退出技巧模式**：
   - 用户点击棋盘单元格 → 触发 handleCellClick → ControlPanel 中的 useEffect 检测到 selectedCell 变化 → 调用 exitTechniqueMode
   - 或用户点击"键盘"标签页 → 直接调用 exitTechniqueMode
   - 执行退出操作：切换标签页、清除高亮、重置状态

### 涉及文件
- `src/components/ControlPanel.jsx`
- `src/pages/SudokuGamePage.jsx`

## 后续扩展
不同的技巧需要开发不同指示方法的技巧指示功能。